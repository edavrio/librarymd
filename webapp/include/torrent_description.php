<?php
// Ids of types that should contain screenshots in description
$types_movie_mandatory_screenshots = array(1,11,12,10,13,5,15,18);

//Movie quality
$conv_movie_quality[1]='DVDRip';
$conv_movie_quality[2]='CAM';
$conv_movie_quality[3]='TELESYNC (TS)';
$conv_movie_quality[4]='TELECINE (TC)';
$conv_movie_quality[5]='SCREENER (SCR)';
$conv_movie_quality[6]='TVRip';
$conv_movie_quality[7]='DVDscr';
$conv_movie_quality[8]='SATRip';
$conv_movie_quality[9]='HDTV';
$conv_movie_quality[10]='HDTVRip';
$conv_movie_quality[11]='BDRip';
$conv_movie_quality[12]='Workprint';
$conv_movie_quality[13]='WEB-DL';
$conv_movie_quality[14]='WEBRip';
$conv_movie_quality[20]='Unknown';

//Appz license
$conv_appz_license[1]='Shareware';
$conv_appz_license[2]='Freeware';
$conv_appz_license[3]='Open source';
$conv_appz_license[4]='Other';
//Appz OS
$conv_appz_os[1]='Windows';
$conv_appz_os[2]='Unix*';
$conv_appz_os[3]='Cross-Platform';
$conv_appz_os[4]='Mobiles*';
$conv_appz_os[5]='Other';
//Language
$conv_language[1]='Русский';
$conv_language[2]='English';
$conv_language[3]='Română';
$conv_language[4]='Deutsch';
$conv_language[5]='Français';
$conv_language[6]='Español';
$conv_language[7]='Japanese';
$conv_language[8]='Italiano';
$conv_language[9]='Portuguese';
$conv_language[10]='Other';
$conv_language[11]='Fără cuvinte';
//Dubbing
$conv_language_type[1] = 'Original (vocea actorilor din film)';
$conv_language_type[2] = 'Traducere dublată';
$conv_language_type[3] = 'Voice-over profesionist cu mai multe vocii';
$conv_language_type[4] = 'Voice-over amator cu mai multe vocii';
$conv_language_type[5] = 'Voice-over cu o singură voce';
$conv_language_type[6] = 'Traducere sincronizată';
$conv_language_type[7] = 'Voice-over-ul cu două voci (amator)';
$conv_language_type[8] = 'Profesionistă (o voce)';
$conv_language_type[9] = 'Profesionistă (două voci)';

//Music genre
$conv_music_genre[1]='A Capela';
$conv_music_genre[2]='Acid';
$conv_music_genre[3]='Acid Jazz';
$conv_music_genre[4]='Acid Punk';
$conv_music_genre[5]='Acoustic';
$conv_music_genre[6]='Alternative';
$conv_music_genre[7]='AlternRock';
$conv_music_genre[8]='Ambient';
$conv_music_genre[9]='Avantgarde';
$conv_music_genre[10]='Ballad';
$conv_music_genre[11]='Bass';
$conv_music_genre[12]='Bebob';
$conv_music_genre[13]='Big Band';
$conv_music_genre[143]='Black Metal';
$conv_music_genre[14]='Bluegrass';
$conv_music_genre[15]='Blues';
$conv_music_genre[16]='Booty Brass';
$conv_music_genre[17]='Cabaret';
$conv_music_genre[18]='Celtic';
$conv_music_genre[19]='Chamber Music';
$conv_music_genre[20]='Chanson';
$conv_music_genre[142]='Chill Out';
$conv_music_genre[21]='Chorus';
$conv_music_genre[22]='Christian Rap';
$conv_music_genre[23]='Classic Rock';
$conv_music_genre[24]='Classical';
$conv_music_genre[25]='Club';
$conv_music_genre[26]='Comedy';
$conv_music_genre[27]='Country';
$conv_music_genre[28]='Cult';
$conv_music_genre[29]='Dance';
$conv_music_genre[30]='Dance Hall';
$conv_music_genre[31]='Darkwave';
$conv_music_genre[32]='Death Metal';
$conv_music_genre[135]='Deathcore';
$conv_music_genre[33]='Disco';
$conv_music_genre[127]='Doom';
$conv_music_genre[134]='Downtempo';
$conv_music_genre[34]='Dream';
$conv_music_genre[133]='Drum&Bass';
$conv_music_genre[35]='Drum Solo';
$conv_music_genre[36]='Duet';
$conv_music_genre[37]='Easy Listening';
$conv_music_genre[38]='Electronic';
$conv_music_genre[128]='Emo';
$conv_music_genre[137]='Emocore';
$conv_music_genre[39]='Ethnic';
$conv_music_genre[40]='Euro-House';
$conv_music_genre[41]='Euro-Techno';
$conv_music_genre[42]='Eurodance';
$conv_music_genre[43]='Fast Fusion';
$conv_music_genre[44]='Folk';
$conv_music_genre[45]='Folk-Rock';
$conv_music_genre[46]='Folklore';
$conv_music_genre[47]='Freestyle';
$conv_music_genre[48]='Funk';
$conv_music_genre[49]='Fusion';
$conv_music_genre[50]='Game';
$conv_music_genre[51]='Gangsta';
$conv_music_genre[52]='Gospel';
$conv_music_genre[53]='Gothic';
$conv_music_genre[54]='Gothic Rock';
$conv_music_genre[139]='Grindcore';
$conv_music_genre[55]='Grunge';
$conv_music_genre[132]='Hardcore';
$conv_music_genre[56]='Hard Rock';
$conv_music_genre[57]='Hip-Hop';
$conv_music_genre[58]='House';
$conv_music_genre[59]='Humour';
$conv_music_genre[60]='Industrial';
$conv_music_genre[61]='Instrumental';
$conv_music_genre[62]='Instrumental Pop';
$conv_music_genre[63]='Instrumental Rock';
$conv_music_genre[64]='Jazz';
$conv_music_genre[65]='Jazz+Funk';
$conv_music_genre[66]='Jungle';
$conv_music_genre[67]='Latin';
$conv_music_genre[68]='Lo-Fi';
$conv_music_genre[69]='Meditative';
$conv_music_genre[70]='Metal';
$conv_music_genre[130]='Metalcore';
$conv_music_genre[138]='Mathcore';
$conv_music_genre[141]='Minimal';
$conv_music_genre[71]='Musical';
$conv_music_genre[72]='National Folk';
$conv_music_genre[73]='Native American';
$conv_music_genre[74]='New Age';
$conv_music_genre[75]='New Wave';
$conv_music_genre[76]='Noise';
$conv_music_genre[77]='Oldies';
$conv_music_genre[78]='Opera';
$conv_music_genre[80]='Polka';
$conv_music_genre[81]='Pop';
$conv_music_genre[82]='Pop-Folk';
$conv_music_genre[83]='Pop/Funk';
$conv_music_genre[84]='Porn Groove';
$conv_music_genre[136]='Post-Hardcore';
$conv_music_genre[85]='Poweer Ballad';
$conv_music_genre[140]='Powerviolence';
$conv_music_genre[86]='Pranks';
$conv_music_genre[87]='Primus';
$conv_music_genre[88]='Progressive Rock';
$conv_music_genre[89]='Psychedelic';
$conv_music_genre[90]='Psychedelic Rock';
$conv_music_genre[91]='Punk';
$conv_music_genre[92]='Punk Rock';
$conv_music_genre[93]='R&B';
$conv_music_genre[94]='Rap';
$conv_music_genre[95]='Rave';
$conv_music_genre[96]='Reggae';
$conv_music_genre[97]='Retro';
$conv_music_genre[98]='Revival';
$conv_music_genre[99]='Rhytmic Soul';
$conv_music_genre[100]='Rock';
$conv_music_genre[101]='Rock & Roll';
$conv_music_genre[102]='Samba';
$conv_music_genre[103]='Satire';
$conv_music_genre[129]='Screamo';
$conv_music_genre[104]='Showtunes';
$conv_music_genre[105]='Ska';
$conv_music_genre[106]='Slow Jam';
$conv_music_genre[107]='Slow Rock';
$conv_music_genre[108]='Sonata';
$conv_music_genre[109]='Soul';
$conv_music_genre[110]='Sound Clip';
$conv_music_genre[111]='Soundtrack';
$conv_music_genre[112]='Southern Rock';
$conv_music_genre[113]='Space';
$conv_music_genre[114]='Speech';
$conv_music_genre[115]='Swing';
$conv_music_genre[116]='Symphonic Rock';
$conv_music_genre[117]='Symphony';
$conv_music_genre[118]='Tango';
$conv_music_genre[119]='Techno';
$conv_music_genre[120]='Techno-Industrial';
$conv_music_genre[131]='Thrash';
$conv_music_genre[121]='Top 40';
$conv_music_genre[122]='Trailer';
$conv_music_genre[123]='Trance';
$conv_music_genre[124]='Tribal';
$conv_music_genre[125]='Trip-Hop';
$conv_music_genre[126]='Vocal';
//New
$conv_music_genre[144] = 'Heavy Metal';
$conv_music_genre[145] = 'Power Metal';

//145 is lastest, MAX IS 150


$conv_music_genre[150]='Other';
$conv_music_genre[151]='Unknown';

//Music Format
$conv_music_format[1]='MP3';
$conv_music_format[2]='M4A';
$conv_music_format[3]='OGG';
$conv_music_format[4]='WMA';
$conv_music_format[5]='AAC';
$conv_music_format[6]='MPC';
$conv_music_format[7]='FLAC';
$conv_music_format[8]='APE';
$conv_music_format[9]='SHN';
$conv_music_format[10]='WV';
$conv_music_format[11]='OFR';
$conv_music_format[12]='WAV';
$conv_music_format[13]='AIFF';
$conv_music_format[14]='SPX';
$conv_music_format[15]='AA';
$conv_music_format[16]='AC3';
$conv_music_format[17]='(multiple)';


$conv_hdtv_quality[1] = 'BDRip 720p';
$conv_hdtv_quality[2] = 'BDRip 1080p';
$conv_hdtv_quality[3] = 'BDRemux';
$conv_hdtv_quality[4] = 'Blu-Ray';
$conv_hdtv_quality[5] = 'HDDVDRip 720p';
$conv_hdtv_quality[6] = 'HDDVDRip 1080p';
$conv_hdtv_quality[7] = 'HDDVDRemux';
$conv_hdtv_quality[8] = 'HDDVD';
$conv_hdtv_quality[9] = 'HDTVRip';
$conv_hdtv_quality[10]='WEB-DL';
$conv_hdtv_quality[11]='WEBRip';


//Movie genres
$conv_movie_genres_list_ids[1]='Action';
$conv_movie_genres_list_ids[20]='Animation';
$conv_movie_genres_list_ids[2]='Adventure';
$conv_movie_genres_list_ids[3]='Biography';
$conv_movie_genres_list_ids[4]='Comedy';
$conv_movie_genres_list_ids[5]='Crime';
$conv_movie_genres_list_ids[6]='Drama';
$conv_movie_genres_list_ids[19]='Detectiv';
$conv_movie_genres_list_ids[21]='Documentary';
$conv_movie_genres_list_ids[7]='Family';
$conv_movie_genres_list_ids[8]='Fantasy';
$conv_movie_genres_list_ids[9]='History';
$conv_movie_genres_list_ids[10]='Horror';
$conv_movie_genres_list_ids[11]='Music';
$conv_movie_genres_list_ids[18]='Mystical';
$conv_movie_genres_list_ids[12]='Romance';
$conv_movie_genres_list_ids[13]='Sci-Fi';
$conv_movie_genres_list_ids[14]='Sport';
$conv_movie_genres_list_ids[15]='Thriller';
$conv_movie_genres_list_ids[16]='War';
$conv_movie_genres_list_ids[17]='Western';
//last = 19

// Hdtv, same genres id as for movies
$conv_hdtv_genre = $conv_movie_genres_list_ids;

//Books genres
$conv_bookz_genre[1] = 'Biography';
$conv_bookz_genre[2] = 'Business & Money';
$conv_bookz_genre[3] = 'Children';
$conv_bookz_genre[4] = 'Computing & Internet';
$conv_bookz_genre[5] = 'Cooking, Food & Wine';
$conv_bookz_genre[6] = 'Diet & Health';
$conv_bookz_genre[7] = 'Education';
$conv_bookz_genre[8] = 'Fiction & Literature';
$conv_bookz_genre[9] = 'History';
$conv_bookz_genre[10] = 'Medicine';
$conv_bookz_genre[11] = 'Mystery & Crime';
$conv_bookz_genre[12] = 'Reference';
$conv_bookz_genre[13] = 'Religion';
$conv_bookz_genre[14] = 'Self-Improvement';

$conv_bookz_genre[15] = 'Science & Technics';
$conv_bookz_genre[100] = 'Other';

$conv_books_genre =& $conv_bookz_genre;

//Games genres
$conv_games_genre[1] = 'Action';
$conv_games_genre[11] = 'Adventure';
$conv_games_genre[2] = 'First-Person Shooters(FPS)';
$conv_games_genre[3] = 'Role-Playing(RPG)';
$conv_games_genre[4] = 'Racing';
$conv_games_genre[5] = 'Real-Time Strategy(RTS)';
$conv_games_genre[13] = 'Simulation';
$conv_games_genre[6] = 'Other Shooters';
$conv_games_genre[7] = 'Tactical Shooters';
$conv_games_genre[12] = 'Turn by Turn Strategy';
$conv_games_genre[8] = 'Platformers';
$conv_games_genre[9] = 'Fighting Games';
$conv_games_genre[10] = 'For Kids';
$conv_games_genre[20] = 'Other';

//Sport genres
$conv_sport_genre[1] = 'Badminton';
$conv_sport_genre[2] = 'Baseball';
$conv_sport_genre[3] = 'Basketball';
$conv_sport_genre[4] = 'Biathlon';
$conv_sport_genre[5] = 'Billiards';
$conv_sport_genre[6] = 'Board Sports';
$conv_sport_genre[7] = 'Boat Racing';
$conv_sport_genre[8] = 'Bobsledding';
$conv_sport_genre[9] = 'Boomerang';
$conv_sport_genre[10] = 'Bowling';
$conv_sport_genre[11] = 'Boxball';
$conv_sport_genre[12] = 'Boxing';
$conv_sport_genre[13] = 'Bullfighting';
$conv_sport_genre[14] = 'Buzkashi';
$conv_sport_genre[15] = 'Camel Racing';
$conv_sport_genre[16] = 'Canoe Polo';
$conv_sport_genre[17] = 'Canoe-Kayak Racing';
$conv_sport_genre[18] = 'Cheerleading';
$conv_sport_genre[19] = 'Cockfighting';
$conv_sport_genre[20] = 'Cricket';
$conv_sport_genre[21] = 'Croquet';
$conv_sport_genre[22] = 'Curling';
$conv_sport_genre[23] = 'Cycling';
$conv_sport_genre[24] = 'Danball';
$conv_sport_genre[25] = 'Dirtsurfing';
$conv_sport_genre[26] = 'Dodgeball';
$conv_sport_genre[27] = 'Dog Racing';
$conv_sport_genre[28] = 'Dogsledding';
$conv_sport_genre[105] = 'Drifting';
$conv_sport_genre[29] = 'Equestrian';
$conv_sport_genre[30] = 'Extreme Sports';
$conv_sport_genre[31] = 'Fencing';
$conv_sport_genre[32] = 'Fighting';
$conv_sport_genre[33] = 'Fishing';
$conv_sport_genre[34] = 'Flying Discs';
$conv_sport_genre[103] = 'Formula 1';
$conv_sport_genre[35] = 'Footbag';
$conv_sport_genre[36] = 'Football';
$conv_sport_genre[37] = 'Freediving';
$conv_sport_genre[38] = 'Golf';
$conv_sport_genre[39] = 'Gymnastics';
$conv_sport_genre[40] = 'Handball';
$conv_sport_genre[41] = 'Hockey';
$conv_sport_genre[42] = 'Horse Racing';
$conv_sport_genre[43] = 'Hurling';
$conv_sport_genre[44] = 'Jai-Alai';
$conv_sport_genre[45] = 'Kabaddi';
$conv_sport_genre[46] = 'Kickball';
$conv_sport_genre[47] = 'Korfball';
$conv_sport_genre[48] = 'Lacrosse';
$conv_sport_genre[49] = 'Le Parkour';
$conv_sport_genre[50] = 'Luge';
$conv_sport_genre[51] = 'Lumbering';
$conv_sport_genre[52] = 'Martial Arts';
$conv_sport_genre[53] = 'Motorcycle Racing';
$conv_sport_genre[54] = 'Mountainboarding';
$conv_sport_genre[55] = 'Netball';
$conv_sport_genre[56] = 'Orienteering';
$conv_sport_genre[57] = 'Paddleball';
$conv_sport_genre[58] = 'Paddling';
$conv_sport_genre[59] = 'Paintball';
$conv_sport_genre[60] = 'Pickleball';
$conv_sport_genre[61] = 'Polo';
$conv_sport_genre[62] = 'Racewalking';
$conv_sport_genre[63] = 'Racquetball';
$conv_sport_genre[64] = 'Ringette';
$conv_sport_genre[65] = 'Rodeo';
$conv_sport_genre[66] = 'Rowing';
$conv_sport_genre[67] = 'Rugby';
$conv_sport_genre[68] = 'Running';
$conv_sport_genre[69] = 'Sailing';
$conv_sport_genre[70] = 'Sandboarding';
$conv_sport_genre[71] = 'Sepak Takraw';
$conv_sport_genre[72] = 'Shinty';
$conv_sport_genre[73] = 'Shooting';
$conv_sport_genre[74] = 'Skateboarding';
$conv_sport_genre[75] = 'Skating';
$conv_sport_genre[76] = 'Skeleton';
$conv_sport_genre[77] = 'Skiing';
$conv_sport_genre[78] = 'Snowboarding';
$conv_sport_genre[79] = 'Snowmobiling';
$conv_sport_genre[80] = 'Soccer';
$conv_sport_genre[81] = 'Softball';
$conv_sport_genre[82] = 'Sports Entertainment';
$conv_sport_genre[83] = 'Squash';
$conv_sport_genre[84] = 'Surfing';
$conv_sport_genre[85] = 'Swimming and Diving';
$conv_sport_genre[86] = 'Table Tennis';
$conv_sport_genre[87] = 'Tchoukball';
$conv_sport_genre[88] = 'Tennis';
$conv_sport_genre[89] = 'Track and Field';
$conv_sport_genre[90] = 'Triathlon';
$conv_sport_genre[91] = 'Tug-of-War';
$conv_sport_genre[92] = 'Twirling';
$conv_sport_genre[93] = 'Volleyball';
$conv_sport_genre[94] = 'Wakeboarding';
$conv_sport_genre[95] = 'Walking';
$conv_sport_genre[96] = 'Water Polo';
$conv_sport_genre[97] = 'Waterskiing';
$conv_sport_genre[98] = 'Weightlifting';
$conv_sport_genre[99] = 'Wheelchair Racing';
$conv_sport_genre[100] = 'Windsurfing';
$conv_sport_genre[101] = 'Winter Sports';
$conv_sport_genre[104] = 'World Cup 10';
$conv_sport_genre[102] = 'Wrestling';
$conv_sport_genre[106] = 'MMA';
$conv_sport_genre[107] = 'K-1';
$conv_sport_genre[108] = 'Muay';

//New

//105 lastest
$conv_sport_genre[150] = 'Other';

//Anime genres
$conv_anime_genre[1] = 'Live Action';
$conv_anime_genre[2] = 'Manga';
$conv_anime_genre[3] = 'Movie';
$conv_anime_genre[4] = 'OVA';
$conv_anime_genre[5] = 'Series';
$conv_anime_genre[6] = 'TV Anime';
$conv_anime_genre[50] = 'Other';

//Dvd genres
$conv_dvd_genre[1]='Action';
$conv_dvd_genre[20]='Animation';
$conv_dvd_genre[2]='Adventure';
$conv_dvd_genre[3]='Biography';
$conv_dvd_genre[4]='Comedy';
$conv_dvd_genre[5]='Crime';
$conv_dvd_genre[6]='Drama';
$conv_dvd_genre[21]='Documentary';
$conv_dvd_genre[19]='Detectiv';
$conv_dvd_genre[7]='Family';
$conv_dvd_genre[8]='Fantasy';
$conv_dvd_genre[9]='History';
$conv_dvd_genre[10]='Horror';
$conv_dvd_genre[11]='Music';
$conv_dvd_genre[18]='Mystical';
$conv_dvd_genre[12]='Romance';
$conv_dvd_genre[13]='Sci-Fi';
$conv_dvd_genre[14]='Sport';
$conv_dvd_genre[15]='Thriller';
$conv_dvd_genre[16]='War';
$conv_dvd_genre[17]='Western';
$conv_dvd_genre[50] = 'Other';

/**
 CIND VEI ADAUGA O NOUA CATEGORIE CU SUBCATEGORII CONTROLEAZA FUNCTIA get_genre(), torrent_translate_raw()
 Fisierele lang details_php_*.php
 Formatul tre sa fie conv_NumeleCategoriei_genre
**/

//Checkboxes
$is_checkbox['serial'] = 1;
$is_checkbox['sample'] = 1;
$is_checkbox['subtitles'] = 1;
$is_checkbox['vbr'] = 1;
$is_checkbox['translated_same_original'] = 1;

//Type Hidden (not show in details, but still in edit)
$is_hidden['translated_same_original'] = 1;

$is_textarea['descr'] = 1;
$is_textarea['games_minimum_hardware'] = 1;
$is_textarea['games_recomanded_hardware'] = 1;

//Separators
$separator_lang['File_info']='File info';
$separator_lang['Hardware']='Hardware';


function get_mandatory_fields($cat_id) {
	global $SETTINGS_PATH;
	$cat_id = (int)$cat_id;
	$bank = unserialize(file_get_contents($SETTINGS_PATH . '/fields_mandatory.txt'));
	if(!isset($bank[$cat_id])) return;
	return $bank[$cat_id];
}

function get_all_fields($cat_id) {
	global $SETTINGS_PATH;
	$cat_id = (int)$cat_id;
	$bank = unserialize(file_get_contents($SETTINGS_PATH .'/fields_all.txt'));
	if(!isset($bank[$cat_id])) return;
	return $bank[$cat_id];
}

function description_add($n,$v,$description) {
	global $description_sep;
	if($description == '') {
	  return $n.':'.$v;
	}
	$v = str_replace($description_sep,'',$v);
	return $description . $description_sep . $n . ':' . $v;
}

/*
  Function to get the torrent description raw
  Info are get from $_GET&$_POST
  Return array['type'] <- the torrent type
         array['description_ar'][field_name] = field_value
         array['description_search_str'] = all mixed in one string, for search matching
*/
function torrent_get_draft() {
	global $types_movie_mandatory_screenshots;
  //Cheking inputs
  if(!isset($_POST['type']) || !is_numeric($_POST['type']) || !in_range($_POST['type'],1,100)) die('Type!');
  $type = (int)$_POST['type'];

  $mandatory_arr = get_mandatory_fields($type);
  foreach($mandatory_arr as $mand_n=>$mand_v) {
  	  if ($mand_v === false) continue;
    if (!isset($_POST[$mand_n]) || (!is_array($_POST[$mand_n]) && strlen($_POST[$mand_n]) == 0) ) {
    	die($mand_n . ' Please go back and fill all mandatory fields, little hacker ;o)');
    }
	//if ($mand_n == 'year' && !in_range($_POST['year'],1850,date('Y')) ) die('Wrong year, click back and write a valid year.');
	if ($mand_n == 'year' && !valid_year($_POST['year'],1850,date('Y') ) ) { //valid_year can check for multiple years, ranges, too
		die('Bad year, click back and write a valid year.');
	}
	if ($mand_n == 'language' && !in_range($_POST['language'],1,20) ) die('Invalid language, click back and choose a language.');
	if ($mand_n == 'language_type' && !in_range($_POST['language_type'],1,20) ) die('Invalid language_type value');

	if ($mand_n == 'movie_quality' && !in_range($_POST['movie_quality'],1,20) ) die('Invalid file quality, click back and choose a properly option.');
	if ($mand_n == 'movie_genres_list_ids' && !preg_match('/^[0-9,]+$/',$_POST['movie_genres_list_ids']) ) die('Invalid movie genres.');
	if ($mand_n == 'music_genre' && !in_range($_POST['music_genre'],1,150) ) die('Invalid genre value');
  }

  $yt_reg_1 = '#^http://www.youtube.com/watch\?v=([\w\d\-]){11}\#t=(\d)+$#i';
  $yt_reg_2 = '#^http://www.youtube.com/watch\?v=([\w\d\-]){11}$#i';
  if (isset($_POST['youtube_link']) && strlen($_POST['youtube_link']) ) {
    if (!preg_match($yt_reg_1,$_POST['youtube_link']) && !preg_match($yt_reg_2,$_POST['youtube_link'])) {
    	$_POST['youtube_link'] = '';
    }
  }

  unset($_POST['imdb_tt_id']);
  $imdb_reg = '#^http://www.imdb.com/title/tt(\d{7})(\/)?$#';
  if (isset($_POST['imdb_link']) && strlen($_POST['imdb_link']) ) {
  	if (!preg_match($imdb_reg,$_POST['imdb_link'],$matches)) {
  		$_POST['imdb_link'] = '';
  	} else {
  		$_POST['imdb_tt_id'] = $matches[1];
  	}
  }

  unset($mandatory_arr);

  //Remove slashes from all inputs

  $t_details = array();
  $description = array();
  $t_details['type']=$type;
  /*
    Our torrent details table have 4 fileds: year lang descr description
  */
  $all_arr = get_all_fields($type);
  //Fields for all torrents
  //$all_arr['year'] = 1;
  //$all_arr['language'] = 1;
  //$all_arr['descr'] = 1;
  $description_string = '';
  $fileds_arr = '';
  foreach($all_arr as $n=>$v) {
	if (isset($_POST[$n]) && !is_array($_POST[$n]) && strlen($_POST[$n]) > 0) {
		$description[$n]=$_POST[$n];
		$description_string=description_add($n,$_POST[$n],$description_string);
		continue;
	}
	if ( (isset($_POST[$n]) && is_array($_POST[$n])) || $n == 'additional') { //Only additional in request list, but not name&descr
      //Handle the custom input, additional_name&additional_descr
      if($n == 'additional' && isset($_POST['additional_name']) && isset($_POST['additional_descr'])) {
      	  $additional=array();
      	  $additional_name = $_POST['additional_name'];
      	  $additional_descr = $_POST['additional_descr'];
      	  if (is_array($additional_name) && is_array($additional_descr) && count($additional_name) > 0 && count($additional_descr) > 0) {
      	  	  for($i=0;$i<count($additional_name);$i++) {
      	  	  	  if(!isset($additional_name[$i]) || !isset($additional_descr[$i]) || strlen($additional_name[$i]) == 0 || strlen($additional_descr[$i]) == 0 ) {
      	  	  	    continue; //Skip bad additionals
      	  	  	  }
      	  	  	  $additional[]=array($additional_name[$i],$additional_descr[$i]); //The 2th will get through bbcode translator
      	  	  }
      	  }
      	  if(count($additional) > 0) {
      	    $description['additional'] = $additional;
      	  }
      	  continue;
      }
      //Separators fields
      if ($n == 'separator' && isset($_POST['separator'])) {
      	  global $separator_lang;
      	  $sep_a = array();
      	  foreach($_POST['separator'] as $sep_n) {
      	  	  if(isset($separator_lang[$sep_n])) {
      	  	  	  $sep_a[] = $sep_n;
      	  	  }
      	  }
      	  if(count($sep_a)>0) {
      	  	  $description['separator'] = $sep_a;
      	  }
      }
    } //End of If isset($_PO..)&&is_array
  }

  $t_details['description_ar'] = $description;
  $t_details['description_search_str'] = $description_string;

  $current_t_description = q_singleval('SELECT descr_ar FROM torrents_details WHERE id=:id',array('id'=>$_POST['id']));
  if (@$current_t_description && serialize($t_details['description_ar']) != $current_t_description ) {
	$descr_ar = serialize($t_details['description_ar']);
	Q( "INSERT INTO torrents_details_versioned (id, changed, descr_ar) VALUES (:id,  NOW(),  :descr_ar)",
	  array('id'=>$_POST['id'], 'descr_ar'=>$descr_ar) );
  }

  return $t_details;
}

/*
  Get the torrent name
    @input - array with elements name of inputs, value it's value
    @type - type
    return the torrent name as a string
*/
function torrent_get_name($input,$type) {
  global $conv_movie_quality, $conv_appz_license, $conv_appz_os, $conv_language, $conv_music_genre, $conv_music_format, $conv_movie_genres_list_ids, $conv_hdtv_quality;
  global $conv_bookz_genre, $conv_sport_genre, $conv_anime_genre, $conv_games_genre;
  $name = '';
  //$type = $t_det['type'];
  //Animation, anime, movies_documentary, tv, video_lessons
  $movies_genred = array(11,10,13,5,15,6,1);
  if (in_array($type,$movies_genred)) {
  	if ($input['movie_translated_name'] == $input['movie_original_name']) {
  		$name = $input['movie_translated_name'] . ' ';
  	} else {
  		$name = $input['movie_original_name'] . ' / ' . $input['movie_translated_name']. ' ';
  	}
  	if(isset($input['serial']) && $input['serial'] == 1) {
  		$serial = '[';
  		if ($input['season'] != '') $serial .= 'Season ' . $input['season'] . (($input['episode'] == '')?']':'/');
  		if ($input['episode'] != '') $serial .= 'Episode ' . $input['episode'] . ']';
  		$name = $name . $serial . ' ';
  	}
  	$movie_quality_id = $input['movie_quality'];
  	if (isset($conv_movie_quality[$movie_quality_id])) $q = $conv_movie_quality[$movie_quality_id];
  	else $q = '';
  	$name = $name . '[' . $input['year'] . ' / ' . $q . ']';

  	if ((isset($input['sample']) && $input['sample'] == 1) || (isset($input['subtitles']) && $input['subtitles'] == 1) ) {
  		$other = '[';
  		if (isset($input['sample']) && $input['sample'] == 1) {
  			$other = $other . 'Sample';
  			$t_sample = 1;
  		}
  		if (isset($input['subtitles']) && $input['subtitles'] == 1) {
  			if (isset($t_sample)) $other = $other . ' / ';
  			$other = $other . 'Subtitle';
  		}
  		$other = $other . ']';
  		$name = $name . ' ' . $other;
  	}

  	//Add genre
  	//For anime
  	if (isset($input['anime_genre']) && isset($conv_anime_genre[$input['anime_genre']]) ) {
  		$name = $name . ' [' . $conv_anime_genre[$input['anime_genre']] . ']';
  	}
  }
  //Especialy for DVD
  if ($type == 12) {
  	if ($input['movie_translated_name'] == $input['movie_original_name']) {
  		$name = $input['movie_translated_name'] . ' ';
  	} else {
  		$name = $input['movie_original_name'] . ' / ' . $input['movie_translated_name']. ' ';
  	}
  	if(isset($input['serial']) && $input['serial'] == 1) {
  		$serial = '[';
  		if ($input['season'] != '') $serial .= 'Season ' . $input['season'] . (($input['episode'] == '')?']':' / ');
  		if ($input['episode'] != '') $serial .= 'Episode ' . $input['episode'] . ']';
  		$name = $name . $serial . ' ';
  	}
  	$name = $name . '[' . $input['year'] . ']';

  	if (isset($input['sample']) && $input['sample'] == 1) {
  		$other = '[';
  		if (isset($input['sample']) && $input['sample'] == 1) {
  			$other = $other . 'Sample';
  		}
  		$other = $other . ']';
  		$name = $name . ' ' . $other;
  	}
  }

  //Especialy for HDTV
  if ($type == 18) {
  	if ($input['movie_translated_name'] == $input['movie_original_name']) {
  		$name = $input['movie_translated_name'] . ' ';
  	} else {
  		$name = $input['movie_original_name'] . ' / ' . $input['movie_translated_name']. ' ';
  	}
  	if(isset($input['serial']) && $input['serial'] == 1) {
  		$serial = '[';
  		if ($input['season'] != '') $serial .= 'Season ' . $input['season'] . (($input['episode'] == '')?']':' / ');
  		if ($input['episode'] != '') $serial .= 'Episode ' . $input['episode'] . ']';
  		$name = $name . $serial . ' ';
  	}
  	$hdtv_quality_id = $input['hdtv_quality'];
  	if (isset($conv_hdtv_quality[$hdtv_quality_id])) $q = $conv_hdtv_quality[$hdtv_quality_id];
  	else $q = '';
  	$name = $name . '[' . $input['year'] . ' / ' . $q . ']';

  	if (isset($input['sample']) && $input['sample'] == 1) {
  		$other = '[';
  		if (isset($input['sample']) && $input['sample'] == 1) {
  			$other = $other . 'Sample';
  		}
  		$other = $other . ']';
  		$name = $name . ' ' . $other;
  	}
  }

  //This should work for movies only
  if (isset($input['movie_genres_list_ids'])) {
  	  $genres = explode(',', $input['movie_genres_list_ids']);
  	  $finit = '';
  	  $max = 3;
  	  foreach($genres as $genre) {
  	  	  if ($max == 0) break;
  	  	  else $max--;

  	  	  if(isset($conv_movie_genres_list_ids[$genre])) {
  	  	  	  $finit = $finit . $conv_movie_genres_list_ids[$genre] . ' / ';
  	  	  }
  	  }
  	  $finit = substr($finit,0,-3); //Remove last 3 char, ' / '
  	  $name .= ' [' . $finit . ']';
  }

  //APZ
  if ($type == 3) {
  	$name = $input['name'] . ' ' . $input['appz_version'];

  	$license_id = $input['appz_license'];
  	$os_id = $input['appz_os'];
  	$lang_id = $input['language'];

  	$license = $conv_appz_license[$license_id];
  	$os = $conv_appz_os[$os_id ];
  	$lang = $conv_language[$lang_id];

      if (1) {
  		$ad = ' [';
  		$after = '';
  		if ($license_id != 4) { //Other
  			$ad = $ad . $license;
  			$after = ' / ';
  		}
  		if($os_id != 1) {
  			$ad = $ad . $after . $os;
  			$after = ' / ';
  		}

  		//Lang
  		//$ad = $ad . $after . substr($lang,0,4);
  		if ($lang != 'Other') {
  			$ad = $ad . $after . $lang;
  		}

  		$after = ' / ';

  		if ($ad != ' [') $name = $name . $ad . ']'; //Prevent emptys
      }
  }
  //Music
  if($type==2) {
  	$name = $input['artist'] . ' - ' . $input['title'] . ' ';
  	//Artist - Title [1997/MP3/225 (VBR)]
  	$format = $conv_music_format[$input['music_format']];
  	$name = $name . '[' . $input['year'] . ' / ' . $format . ' / ' . $input['music_bitrate'];
  	if(isset($input['vbr']) && $input['vbr'] == 1) {
  		$name = $name . ' (VBR)';
  	}
  	//Add genre
  	if ( isset($conv_music_genre[ $input['music_genre'] ]) ) {
  		$name = $name . '] [' . $conv_music_genre[$input['music_genre']] . ']';
  	}
  }

  //Music Video
  if ($type==9) {
  	$name = $input['artist'] . ' - ' . $input['title'] . ' ';
  	$format = $conv_music_format[$input['music_format']];
  	$name = $name . '[' . $input['year'];
  	if (isset($input['sample']) && $input['sample'] == 1) {
  		$name = $name . ' / ' . 'Sample';
  	}
  	$name = $name . ']';
  }

  //Bookz
  if ($type == 8) {
  	  $name = $input['name'] . ' ' . ' [' . $input['year'];
  	  if (isset($input['language']) && $conv_language[$input['language']] != 'Other') $name = $name . ' / ' . $conv_language[$input['language']];
  	  $name = $name . ']';
  	  //Add genre
  	  if ( isset($conv_bookz_genre[ $input['bookz_genre'] ]) ) {
  	  	  $name = $name . ' [' . $conv_bookz_genre[$input['bookz_genre']] . ']';
  	  }
  }

  //Games
  if ($type == 4) {
  	  $name = $input['name'] . ' ' . ' [' . $input['year'];
  	  if (isset($input['language']) && $conv_language[$input['language']] != 'Other') $name = $name . ' / ' . $conv_language[$input['language']];
  	  $name = $name . ']';
  	  //Add genre
  	  if ( isset($conv_games_genre[ $input['games_genre'] ]) ) {
  	  	  $name = $name . ' [' . $conv_games_genre[$input['games_genre']] . ']';
  	  }
  }

  //Sport
  if ($type == 17) {
	$name = $input['name'] . ' ';

  	if(isset($input['serial']) && $input['serial'] == 1) {
  		$serial = '[';
  		if ($input['season'] != '') $serial .= 'Season ' . $input['season'] . (($input['episode'] == '')?']':' / ');
  		if ($input['episode'] != '') $serial .= 'Episode ' . $input['episode'] . ']';
  		$name = $name . $serial . ' ';
  	}

  	$movie_quality_id = $input['movie_quality'];
  	if (isset($conv_movie_quality[$movie_quality_id])) $q = $conv_movie_quality[$movie_quality_id];
  	else $q = '';
  	$name = $name . '[' . $input['year'] . ' / ' . $q . ']';

  	if ((isset($input['sample']) && $input['sample'] == 1) || (isset($input['subtitles']) && $input['subtitles'] == 1) ) {
  		$other = '[';
  		if (isset($input['sample']) && $input['sample'] == 1) {
  			$other = $other . 'Sample';
  			$t_sample = 1;
  		}
  		if (isset($input['subtitles']) && $input['subtitles'] == 1) {
  			if (isset($t_sample)) $other = $other . ' / ';
  			$other = $other . 'Subtitle';
  		}
  		$other = $other . ']';
  		$name = $name . ' ' . $other;
  	}

  	  //Add genre
  	  if ( isset($conv_sport_genre[ $input['sport_genre'] ]) ) {
  	  	  $name = $name . ' [' . $conv_sport_genre[$input['sport_genre']] . ']';
  	  }
  }

  //The default name generator
  //8 Books 14 Books Audio
  //Name [year/lang]
  if ($name == '') {
  	$name = $input['name'] . ' ' . ' [' . $input['year'];
  	if(isset($input['language']) && $conv_language[$input['language']] != 'Other') $name = $name . ' / ' . $conv_language[$input['language']];
  	$name = $name . ']';
  }
  return $name;
}

/*
  torrent_translate_raw
  Return an array, each element is another array with [0] the name and [1] the value
  @input - array with fields
  return - array
*/
function torrent_translate_raw($input, $catId) {
  global $lang,$conv_language,$conv_language_type,$conv_movie_quality;
  global $conv_movie_genres_list_ids,$conv_music_format,$conv_music_genre,$conv_appz_os,$conv_appz_license,$conv_hdtv_quality;
  global $conv_bookz_genre,$conv_games_genre,$conv_sport_genre,$conv_anime_genre,$conv_dvd_genre,$conv_hdtv_genre;
  global $is_checkbox,$is_hidden;
  $descr=array();
  foreach($input as $n => $v) {
  	  //Tranlsate the index to the real thinks, example language 2 would be English..and so on
  	  if (isset(${'conv_'.$n}) && (isset(${'conv_'.$n}[$v]) || $n == 'movie_genres_list_ids')) {
  	  	  if ($n == 'movie_genres_list_ids') { //Movies genres can be in next format: 2,3,4,5..
  	  	  	  $genres = explode(',', $v);
  	  	  	  $finit = '';
  	  	  	  foreach($genres as $genre) {
  	  	  	  	  if(isset($conv_movie_genres_list_ids[$genre])) {
  	  	  	  	  	  $genreLink = '<a href="./browse.php?cat='.$catId.'&genre='.$genre.'">';
  	  	  	  	  	  $finit = $finit . $genreLink . $conv_movie_genres_list_ids[$genre] . '</a> / ';
  	  	  	  	  }
  	  	  	  }
  	  	  	  $finit = substr($finit,0,-2); //Remove last 2 chars, the '/ '
  	  	  	  $v = $finit;
  	  	  } else {
  	  	  	  $v = ${'conv_'.$n}[$v];
			  if($n == 'language' && isset($input['transl_info']) && !isset($input['language_type']) ) {
			  	  $v .= ' ' . $input['transl_info'];
			  }
			  if($n == 'language' && isset($input['language_type'])) {
			  	  if (isset($conv_language_type[$input['language_type']])) {
			  	  	  $v .= sprintf(' language_type{%d}',$input['language_type']);
			  	  }
			  }
  	  	  }
	  }
	  if ($n == 'additional') {
		  foreach($v as $a) {
			  $descr[$a[0]]=$a[1];
		  }
		  continue;
	  }
	  if ($n == 'separator') { //Separators are already validated in drafts, we don't need to revalidate now
	  	  if (count($v) > 0) $descr[$n]=$v;
	  	  continue;
	  }
	  if ($n == 'transl_info' || $n == 'language_type') {
	  	  continue; //We don't need transl_info separate because we already have it in the end of lang
	  }
	  if (isset($is_hidden[$n])) continue; //We don't need that in details

	  if (isset($is_checkbox[$n]) && $v == 1) {
	  	  $descr[$n]='{Yes}';
	  }

	  else $descr[$n]=$v;
  }
  return $descr;
}
/*
  Decorize, pass description trough bb compiler
  @input - must be the array result of get_full_description
  result must be a string
*/
function torrent_get_html($input) {
	$str = '';
	foreach($input as $v[0]=>$v[1]) {
		if ($v[0] == 'descr') {
			$v[1] = format_comment($v[1]);
			$str .=  '<b>'.$v[0].'</b>:' . ' ' . $v[1] . '<br>'."\n";
			continue;
		}
		if($v[0] == 'separator' && is_array($v[1])) { //Array in separator must be already validated, so we can put it here without fear
			foreach($v[1] as $sep) {
				$str .= '<h2>'.$sep.'</h2>'."\n";
			}
			continue;
		}
		if ($v[0] == 'movie_genres_list_ids') { // Genres contain links, esc will brake them, avoid esc
			$str .= '<b>'.$v[0].'</b>:' . ' ' . $v[1] . '<br>'."\n";
			continue;
		}
		if ($v[0] == 'movie_quality') {
			$str .= sprintf('<b>%s</b>: <a href="/forum.php?action=viewtopic&topicid=361692#3" target="_blank">%s</a><br>'."\n",$v[0],esc_html($v[1]));
			continue;
		}
		if ($v[0] == 'imdb_link' || $v[0] == 'imdb_tt_id') {
			continue;
		}
		if ($v[0] == 'youtube_link') {
			$str .= '<b>Trailer</b>:' . ' ' . format_comment(sprintf('[spoiler=Trailer][yt]%s[/yt][/spoiler]',$v[1])) . '<br>'."\n";
			continue;
		}
		$str .= '<b>'. esc_html($v[0]) .'</b>:' . ' ' . esc_html($v[1]) . '<br>'."\n";
	}
	return $str;
}

function get_search_insert($raw_arr,$name,$type) {
	$name = mb_strtolower($name);
	$year = isset($raw_arr['year'])?$raw_arr['year']:'';
	$lang = $raw_arr['language'];

	//echo $name . ' ' . $year . ' ' . $lang;


	if ($type == 3) { //Appz
		$genre = $raw_arr['appz_license'];
	} elseif ($type == 8 || $type == 14) { //Books
		$genre = $raw_arr['bookz_genre'];
	} elseif ($type == 1 || $type == 12 || $type == 18) { //Movies,DVD,HDTV
		$genre = $raw_arr['movie_genres_list_ids'];
	} elseif ($type == 4) { //Games
		$genre = $raw_arr['games_genre'];
	} elseif ($type == 2) { //Music
		$genre = $raw_arr['music_genre'];
	} else $genre = 0;

	$sql = array();
	$sql['name'] = _esc($name);
	$sql['year'] = _esc($year);
	$sql['lang'] = _esc($lang);
	$sql['genre'] = _esc($genre);

	/*return "INSERT INTO searchindex (id,name,year,lang,type)
		    VALUES ({id},$sql[name],$sql[year],$sql[lang],$sql[type])";*/
	return $sql;
}


function get_genre($raw_arr) {
	//Inputurile de subcategorii
	$genres_id = array('movie_genres_list_ids', 'bookz_genre', 'music_genre', 'games_genre', 'sport_genre', 'anime_genre', 'dvd_genre');

	foreach ($genres_id as $gid) {
		if (isset($raw_arr[$gid]) && strlen($raw_arr[$gid]) > 0) {
			if (strpos($raw_arr[$gid],','))	return explode(',',$raw_arr[$gid]);
			return $raw_arr[$gid];
		}
	}
}

function get_year($raw_arr) {
	if (!isset($raw_arr['year'])) return;
	$year = $raw_arr['year'];
	if (strpos($year,',') === false && strpos($year,'-') === false) {
		return $year;
	}
	$rez_years = array();
	$year = explode(',',$year);
	foreach($year as $y) {
		if (strpos($y,'-') !== false) {
			list($from,$to) = explode('-',$y);
			for ($cur_y=$from; $cur_y<=$to; $cur_y++) { //Ranges must be already validated, so we don't need to worry ? ;o)
				if (!in_array($cur_y,$rez_years)) $rez_years[] = $cur_y;
			}
		} else {
			if (!in_array($y,$rez_years)) $rez_years[] = $y;
		}
	}
	return($rez_years);
}

/*
  torrent_get_array_of_description
  return array(
  				'name'=>torrent name
  				'type'=>torrent type
  				'description_ar'=>a serializes array of input description fields
  				'description_search_str'=>a string with all input description fields and it's value
  				'description_details_html'=>a string what will putted directly to details page
  			  )
*/
function torrent_get_array_of_description() {
	$t_det = torrent_get_draft();
	$r = array();
    $r['name'] = esc_html(torrent_get_name($t_det['description_ar'],$t_det['type']));
    $r['type'] = $t_det['type'];
    $r['genre'] = get_genre($t_det['description_ar']); //One genre, or multiple genres in a array
    $r['year'] = get_year($t_det['description_ar']); //One year, or multiple years in a array
    if (isset($t_det['description_ar']['imdb_tt_id'])) {
    	$r['imdb_tt_id'] = $t_det['description_ar']['imdb_tt_id'];
    }

	$r['description_ar'] = serialize($t_det['description_ar']); //Real post values for edit
	$r['description_search_str'] = $t_det['description_search_str'];
	$r['search_sql'] = get_search_insert($t_det['description_ar'],$r['name'],$t_det['type']);

	$translated = torrent_translate_raw($t_det['description_ar'], $r['type']); //Put genres names..etc



	$r['description_details_html'] = torrent_get_html($translated);

	if (strlen($r['description_ar']) > 65535 || strlen($r['description_search_str']) > 65535 || strlen($r['description_details_html']) > 65535) {
		die('You post too much information about this torrent, please put less data.');
	}

	return $r;
}

/*
	Torrent Image Functions
*/

function check_torrent_image() {
	//Check if a image is also uploaded
	if (isset($_FILES['file_image']) && $_FILES['file_image']['name'] != "") { //Photo upload
		$f = $_FILES['file_image'];
		$fname = strtolower($f['name']);
		$tmpname = $f['tmp_name'];
		// Let's see if image has been uploaded
		if (!is_uploaded_file($tmpname)) { show_error('ERROR! Can\'t get the uploaded image, please reupload.'); }
		if (!filesize($tmpname)) { show_error('ERROR! Uploaded image is empty.'); }
		// Now let's validate the image
		/*$ext = get_extension($fname);
		if (!preg_match('/jpg|jpeg|png/i', $ext)) { show_error('ERROR! Uploaded image can have the jpg or png extension only.'); }
		if ($ext == 'jpeg') $ext = 'jpg';*/
		list($width, $height, $type, $attr) = getimagesize($tmpname);
		if ($type != 2 && $type != 3) { show_error('ERROR! Only a jpg or png image are allowed.'); }
		if ($type == 2) $ext = 'jpg';
		elseif ($type == 3) $ext = 'png';
		// New location name
		if ($width < 100 || $height < 100) {
			show_error('ERROR! The minimum image dimension is 100x100.');
		}
		$sh = substr( sha1_file($tmpname) , 0, 3);
		$filename = $sh . '.' . $ext;
		return array($filename,$tmpname);
	}
	return array(0,0);
}

// ########################################################
// Ussed to resize images proportionally to specified width or specified height
// ########################################################

function resize_prop($src,$dst,$to_width,$to_height="",$no_move=0) {
	list($width, $height, $type, $attr) = getimagesize($src);
	if ($type == 2) $ext = 'jpg';
	elseif ($type == 3) $ext = 'png';
	else show_error('Bad image.');

	// Check if we really need to resize ;)
	if ($width <= $to_width && $height <= $to_height) {
		//Doing optimization only for jpg
		if ($ext == 'jpg') {
			compress_jpeg($src,$dst);
			//That mean a move action are made
			if ($no_move == 0) {
				unlink($src);
			}
		} elseif($ext == 'png') {
			compress_png($src,$dst);
			if ($no_move == 0) {
				unlink($src);
			}
			//move_uploaded_file($src,$dst);
		}
		return;
	}

	// Now we'll need GD ;p
	if ($ext == 'jpg') $im = imagecreatefromjpeg($src);
	elseif ($ext == 'png') $im = imagecreatefrompng($src);
	$dstw = $to_width;
	$dsth = ceil($to_width/($width/$height));
	if ($to_height != "" && $dsth > $to_height) {
		$dsth = $to_height;
		$dstw = ceil($to_height/($height/$width));
	}
	$tim = imagecreatetruecolor($dstw,$dsth);
	imagecopyresampled($tim,$im,0,0,0,0,$dstw,$dsth,$width,$height);
	if ($ext == 'png') {
		$tim = ImageTrueColorToPalette2($tim,false,255);
	}
	if ($ext == 'jpg') imagejpeg($tim,$dst,85);
	elseif ($ext == 'png') imagepng($tim,$dst);
	imagedestroy($tim);
    imagedestroy($im);
}

function ImageTrueColorToPalette2($image, $dither, $ncolors) {
	$width = imagesx( $image );
	$height = imagesy( $image );
	$colors_handle = ImageCreateTrueColor( $width, $height );
	ImageCopyMerge( $colors_handle, $image, 0, 0, 0, 0, $width, $height, 100 );
	ImageTrueColorToPalette( $image, $dither, $ncolors );
	ImageColorMatch( $colors_handle, $image );
	ImageDestroy($colors_handle);
	return $image;
}

function compress_png($src,$dst) {
   list($width, $height, $type, $attr) = getimagesize($src);
   $im = imagecreatefrompng($src);
   $tim = imagecreatetruecolor($width,$height);
   imagecopyresampled($tim,$im,0,0,0,0,$width,$height,$width,$height);
   $tim = ImageTrueColorToPalette2($tim,false,255);
   imagepng($tim,$dst);
}

function compress_jpeg($input_file, $output_file) {
    $img = ImageCreateFromJPEG($input_file);
    imageinterlace($img,1);
    $compressed = ImageJPEG($img, $output_file, 80);
    ImageDestroy($img);
    return 1;
}
function get_extension($file_name) {
	return strtolower(trim(substr($file_name, -4, 4),'.'));
}

function valid_year($year,$from,$to) {
	if (strpos($year,',') !== false || strpos($year,'-') !== false) {
		$years = explode(',',$year);
		foreach ($years as $y) {
			if (strpos($y,'-') !== false) {
				list($range_from,$range_to) = explode('-',$y);
				if ($range_from > $range_to) return false;
				if ($range_from === $range_to) return false;
				if (!in_range($range_from,$from,$to) || !in_range($range_to,$from,$to)) {
					return false;
				}
			} else {
				if (!in_range($y,$from,$to)) return false;
			}
		}
		return true;
	} else {
		if (!in_range($year,$from,$to)) return false;
		else return true;
	}
}
?>